<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Betopia Bot System Architecture</title>
    <style>
        :root { --bg: #0d1117; --file: #161b22; --border: #30363d; --code: #7ee787; --header: #58a6ff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #c9d1d9; padding: 20px; line-height: 1.5; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        
        .file-block { background: var(--file); border: 1px solid var(--border); border-radius: 8px; padding: 20px; position: relative; }
        .file-name { color: var(--header); font-family: monospace; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; display: block; }
        
        .function { margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px; border-left: 3px solid var(--header); }
        .func-name { font-weight: bold; color: #d2a8ff; font-family: monospace; }
        .func-desc { font-size: 0.85rem; color: #8b949e; display: block; margin-top: 4px; }
        
        .arrow-right { text-align: center; font-size: 2rem; padding: 10px; color: var(--border); }
        .data-flow { font-size: 0.75rem; background: #238636; color: white; padding: 2px 6px; border-radius: 10px; vertical-align: middle; }
    </style>
</head>
<body>

<h1 style="text-align:center;">System Workflow: File-by-File Execution</h1>

<div class="grid">
    <div class="file-block">
        <span class="file-name">ðŸ“‚ app/rag/embeddings.py</span>
        <div class="function">
            <span class="func-name">describe_image(img_path)</span>
            <span class="func-desc">Encodes image to Base64 âž” Sends to GPT-4o Vision âž” Returns Text Description.</span>
        </div>
        <div class="function">
            <span class="func-name">embed_texts(texts)</span>
            <span class="func-desc">Sends text/captions to OpenAI `text-embedding-3-small`. Returns 1536-dim vectors.</span>
        </div>
        <div class="arrow-right">âž” <span class="data-flow">Vectors</span></div>
    </div>

    <div class="file-block">
        <span class="file-name">ðŸ“‚ app/rag/vector_store.py</span>
        <div class="function">
            <span class="func-name">get_chroma_collection()</span>
            <span class="func-desc">Initializes PersistentClient. Creates or loads the SQLite database on disk.</span>
        </div>
        <div class="function">
            <span class="func-name">collection.add()</span>
            <span class="func-desc">Stores raw text + vectors + metadata (IDs, filenames) into the HNSW graph.</span>
        </div>
        <div class="arrow-right">âž” <span class="data-flow">Stored Index</span></div>
    </div>

    <div class="file-block">
        <span class="file-name">ðŸ“‚ app/main.py (The Orchestrator)</span>
        <div class="function">
            <span class="func-name">Ingestion Loop</span>
            <span class="func-desc">Triggers `load_pdf` and `describe_image`. Merges everything into a single list for the database.</span>
        </div>
        <div class="function">
            <span class="func-name">Chat Loop</span>
            <span class="func-desc">Takes `input()`, calls `collection.query()`, builds prompt, and gets LLM response.</span>
        </div>
        <div class="arrow-right">âž” <span class="data-flow">Final Answer</span></div>
    </div>
</div>

<div style="margin-top: 40px; padding: 20px; background: #1c2128; border-radius: 8px; border: 1px dashed #58a6ff;">
    <h3>The Unified "Brain" Logic</h3>
    <p>Inside <b>main.py</b>, the most important "block" is the <b>Context Retrieval</b>:</p>
    <ol>
        <li>User asks a question about an <b>Image</b>.</li>
        <li>ChromaDB looks at the vectors created by <b>embeddings.py</b>.</li>
        <li>It finds the "Text Description" of that image because the vectors are mathematically similar.</li>
        <li>The description is sent to GPT-4o-mini as "The Truth" (Context).</li>
        <li>The bot replies as if it can see the image!</li>
    </ol>
</div>

</body>
</html>